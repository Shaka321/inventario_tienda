{% extends "base_tw.html" %}
{% block title %}Finanzas ¬∑ Panel{% endblock %}

{% block head_extra %}
  <!-- Inter (tipograf√≠a del ejemplo) -->
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    :root { font-family: 'Inter', system-ui, sans-serif; }
    @supports (font-variation-settings: normal) {
      :root { font-family: 'Inter var', system-ui, sans-serif; }
    }
  </style>
{% endblock %}

{% block content %}
<!-- Full-bleed para escapar del max-w del layout y ocupar 100vw -->
<div class="relative left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] w-screen antialiased bg-black text-slate-300 min-h-screen py-4">

  <div class="grid grid-cols-12 mx-auto gap-2 sm:gap-4 md:gap-6 lg:gap-10 xl:gap-14 max-w-7xl my-10 px-2">

      <!-- CONTENT (100% ancho sin sidebar) -->
    <main id="content" class="bg-white/10 col-span-12 rounded-lg p-6 ring-1 ring-white/10">

    <!-- CONTENIDO -->
    <section id="content" class="bg-white/10 col-span-12 md:col-span-9 rounded-lg p-6">

      <!-- Rango y Export -->
      <div class="mb-6 space-y-4">
        <h2 class="font-bold text-xl">üìä M√≥dulo de Finanzas y Reportes</h2>

        <form method="GET" action="{{ url_for('main.fin_panel') }}" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
          <div class="md:col-span-3">
            <label class="text-sm text-slate-400">Rango</label>
            <select name="r" id="rango" class="w-full rounded-lg bg-black/40 border border-white/10 px-3 py-2">
              <option value="hoy"           {% if r=='hoy' %}selected{% endif %}>Hoy</option>
              <option value="semana"        {% if r=='semana' %}selected{% endif %}>√öltimos 7 d√≠as</option>
              <option value="mes"           {% if r=='mes' %}selected{% endif %}>Mes actual</option>
              <option value="personalizado" {% if r=='personalizado' %}selected{% endif %}>Personalizado</option>
            </select>
          </div>

          <div id="fechas" class="md:col-span-5 grid grid-cols-2 gap-3 {% if r!='personalizado' %}hidden{% endif %}">
            <div>
              <label class="text-sm text-slate-400">Desde</label>
              <input type="date" name="desde" value="{{ desde }}" class="w-full rounded-lg bg-black/40 border border-white/10 px-3 py-2">
            </div>
            <div>
              <label class="text-sm text-slate-400">Hasta</label>
              <input type="date" name="hasta" value="{{ hasta }}" class="w-full rounded-lg bg-black/40 border border-white/10 px-3 py-2">
            </div>
          </div>

          <div class="md:col-span-2">
            <button class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 px-4 py-2 font-semibold">Aplicar</button>
          </div>

          <div class="md:col-span-12 text-sm text-slate-400">
            {{ rango_label }}: <span class="text-slate-200">{{ desde }}</span> ‚Üí <span class="text-slate-200">{{ hasta }}</span>
          </div>
        </form>

        <!-- Export -->
        <div class="flex flex-wrap gap-2 items-center bg-black/40 border border-white/10 rounded-lg p-3">
          <div class="text-sm text-slate-400">Exportar CSV:</div>
          <a class="px-3 py-1.5 rounded-lg bg-emerald-700/70 hover:bg-emerald-600 font-semibold"
             href="{{ url_for('main.export_ventas_filtrado') }}?r={{ r }}&desde={{ desde }}&hasta={{ hasta }}">‚¨áÔ∏è Ventas (filtrado)</a>
          <a class="px-3 py-1.5 rounded-lg bg-rose-700/70 hover:bg-rose-600 font-semibold"
             href="{{ url_for('main.export_gastos_filtrado') }}?r={{ r }}&desde={{ desde }}&hasta={{ hasta }}">‚¨áÔ∏è Gastos (filtrado)</a>
          <span class="ms-auto text-sm text-slate-400">
            <a class="hover:underline" href="/export/ventas.csv">Todo ventas</a> ¬∑
            <a class="hover:underline" href="/export/gastos.csv">Todo gastos</a>
          </span>
        </div>
      </div>

      <!-- Tarjetas resumen -->
      <div class="grid gird-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-black/60 p-6 rounded-lg">
          <p class="text-emerald-300 text-sm font-medium uppercase">Ingresos</p>
          <p class="text-white font-bold text-3xl mt-1">{{ '%.2f'|format(total_ventas|float) }}</p>
        </div>
        <div class="bg-black/60 p-6 rounded-lg">
          <p class="text-rose-300 text-sm font-medium uppercase">Gastos</p>
          <p class="text-white font-bold text-3xl mt-1">{{ '%.2f'|format(total_gastos|float) }}</p>
        </div>
        <div class="bg-black/60 p-6 rounded-lg">
          <p class="text-indigo-300 text-sm font-medium uppercase">Ganancia neta</p>
          <p class="text-white font-bold text-3xl mt-1">{{ '%.2f'|format(ganancia_neta|float) }}</p>
        </div>
      </div>

      <!-- Gr√°ficos -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-black/60 p-6 rounded-lg">
          <h3 class="font-bold mb-3">Ventas por d√≠a</h3>
          <canvas id="graficoVentas" height="200"></canvas>
        </div>
        <div class="bg-black/60 p-6 rounded-lg">
          <h3 class="font-bold mb-3">Ingresos vs Egresos</h3>
          <canvas id="graficoResumen" height="200"></canvas>
        </div>
        <div class="bg-black/60 p-6 rounded-lg">
          <h3 class="font-bold mb-3">Productos m√°s vendidos (Top 5)</h3>
          <div class="mx-auto max-w-xs h-56">
            <canvas id="graficoTop"></canvas>
          </div>
        </div>
      </div>

    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Paquete de datos seguro para JS (evita lints y Undefined) -->
  <script id="fin-data" type="application/json">
  {{ {
      "ventas_labels": ventas_labels | default([], true),
      "ventas_values": ventas_values | default([], true),
      "total_ventas":  total_ventas  | default(0,  true),
      "total_gastos":  total_gastos  | default(0,  true),
      "top_labels":    top_labels    | default([], true),
      "top_values":    top_values    | default([], true)
    } | tojson }}
  </script>

  <script>
    // Mostrar/ocultar fechas personalizadas
    (function(){
      const rangoSel = document.getElementById('rango');
      const fechasDiv = document.getElementById('fechas');
      if (rangoSel) {
        rangoSel.addEventListener('change', function () {
          if (this.value === 'personalizado') fechasDiv.classList.remove('hidden');
          else fechasDiv.classList.add('hidden');
        });
      }
    })();

    // ===== Cargar datos desde el <script type="application/json"> =====
    const finDataEl = document.getElementById('fin-data');
    let FIN = {};
    try {
      FIN = JSON.parse(finDataEl?.textContent || "{}");
    } catch (e) {
      FIN = {};
    }

    const ventasLabels  = Array.isArray(FIN.ventas_labels) ? FIN.ventas_labels : [];
    const ventasValues  = Array.isArray(FIN.ventas_values) ? FIN.ventas_values : [];
    const totalIngresos = typeof FIN.total_ventas === "number" ? FIN.total_ventas : 0;
    const totalEgresos  = typeof FIN.total_gastos === "number" ? FIN.total_gastos : 0;
    const topLabels     = Array.isArray(FIN.top_labels) ? FIN.top_labels : [];
    const topValues     = Array.isArray(FIN.top_values) ? FIN.top_values : [];
    
    // Paleta simple para modo oscuro
    const gridColor = 'rgba(255,255,255,0.1)';
    const tickColor = 'rgba(255,255,255,0.7)';

    function makeBarConfig(labels, data, label){
      return {
        type: 'bar',
        data: { labels, datasets: [{ label, data, borderWidth: 1 }]},
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { grid: { color: gridColor }, ticks: { color: tickColor }},
            y: { grid: { color: gridColor }, ticks: { color: tickColor }}
          }
        }
      };
    }

    function makePieConfig(labels, data){
      return {
        type: 'pie',
        data: { labels, datasets: [{ data }]},
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e5e7eb' } } }
        }
      };
    }

    // Inicializar gr√°ficos
    new Chart(
      document.getElementById('graficoVentas'),
      makeBarConfig(ventasLabels, ventasValues, 'Ventas por d√≠a')
    );

    new Chart(
      document.getElementById('graficoResumen'),
      makeBarConfig(['Ingresos','Egresos'], [totalIngresos, totalEgresos], 'Resumen')
    );

    new Chart(
      document.getElementById('graficoTop'),
      makePieConfig(topLabels, topValues)
    );

    // L√≥gica de formulario "Registrar venta" (si ese formulario est√° en esta p√°gina)
    (function(){
      const sel = document.getElementById('producto');
      if (!sel) return;
      const radios = document.querySelectorAll('input[name="modo"]');
      const cantidad = document.getElementById('cantidad');
      const precioUnit = document.getElementById('precio_unit');
      const totalShown = document.getElementById('total_mostrado');
      const totalHidden = document.getElementById('total_hidden');
      const stockSpan = document.getElementById('stock_actual');
      const infoPack = document.getElementById('info_pack');

      function getSelectedData(){
        const opt = sel.options[sel.selectedIndex];
        if (!opt) return {};
        return {
          precioUnit: parseFloat(opt.getAttribute('data-precio-unit')) || 0,
          stock: parseInt(opt.getAttribute('data-stock')) || 0,
          precioPack: parseFloat(opt.getAttribute('data-precio-pack')) || 0,
          unidadesPack: parseInt(opt.getAttribute('data-unidades-pack')) || 0
        };
      }

      function updateUI(){
        const data = getSelectedData();
        const modo = (document.querySelector('input[name="modo"]:checked') || {}).value || 'unidad';

        if (stockSpan) stockSpan.textContent = data.stock ? data.stock : '-';

        if (modo === 'unidad') {
          if (precioUnit) precioUnit.value = data.precioUnit ? data.precioUnit.toFixed(2) : '';
          if (infoPack) infoPack.textContent = '';
        } else {
          if (precioUnit) precioUnit.value = data.precioPack ? data.precioPack.toFixed(2) : '';
          if (infoPack) infoPack.textContent = data.unidadesPack ? `(1 paquete = ${data.unidadesPack} unid.)` : '(este producto no tiene paquete configurado)';
        }

        const cant = parseFloat((cantidad && cantidad.value) || 0);
        const p = parseFloat((precioUnit && precioUnit.value) || 0);
        const tot = cant * p;
        if (totalShown)  totalShown.value  = tot ? tot.toFixed(2) : '';
        if (totalHidden) totalHidden.value = tot ? tot.toFixed(2) : '';
      }

      sel.addEventListener('change', updateUI);
      radios.forEach(r => r.addEventListener('change', updateUI));
      if (cantidad) cantidad.addEventListener('input', updateUI);
      updateUI();
    })();
  </script>
{% endblock %}
